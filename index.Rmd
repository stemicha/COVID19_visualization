---
title: "COVID19 visualization"
author: "Stephan Michalik"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
mail: "stephan.michalik@uni-greifswald.de"
output: 
  html_document:
    theme: yeti
    highlight: breezedark
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float:
      collapsed: true
      smooth_scroll: true
      number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F,message=F,warning=F,fig.width=10,fig.height=6)
```

COVID 2019 data from European Centre for Disease Prevention and Control 

```{r}
# COVID 2019 data from European Centre for Disease Prevention and Control


#these libraries are necessary

library(readxl)
library(httr)
library(gganimate)
library(tidyverse)
library(lubridate)
library(ggrepel)
library(plotly)
library(patchwork)
library(hrbrthemes)
library(maps)

#colors setup
my_colors <- c("#5F4690","#1D6996","#38A6A5","#0F8554","#73AF48","#EDAD08","#E17C05","#CC503E","#94346E","#6F4070","#994E95","#666666")

#create the URL where the dataset is stored with automatic updates every day

url <- paste("https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide-",format(Sys.time(), "%Y-%m-%d"), ".xlsx", sep = "")
#url <- "https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide-2020-03-21.xlsx"
#download the dataset from the website to a local temporary file

GET(url, authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".xlsx")))

#read the Dataset from url

data_in <- read_excel(tf)

#write_file
write_delim(x = data_in,path = "COVID_cases_deaths_reported_by_ECDC.tab",delim = "\t",col_names = T)

data_aggregated <- data_in %>% 
  group_by(`Countries and territories`) %>% 
  summarise(sum_of_cases = sum(Cases),sum_of_deaths = sum(Deaths)) %>% 
  arrange(desc(sum_of_cases))

#sum up day for day cases and deaths
data_in <- data_in %>%  mutate(day_start = dense_rank(DateRep))

data_in$day_sum_cases <- NA
data_in$day_sum_deaths <- NA

for(i in unique(data_in$GeoId)){
  for(k in unique(data_in$day_start)){
    data_in$day_sum_cases[which(data_in$GeoId==i & data_in$day_start==k)] <- 
      sum(data_in$Cases[which(data_in$GeoId==i & data_in$day_start<=k)])
    data_in$day_sum_deaths[which(data_in$GeoId==i & data_in$day_start==k)] <- 
      sum(data_in$Deaths[which(data_in$GeoId==i & data_in$day_start<=k)])
  }
}


#select  Top10 countries
top10<- data_aggregated[1:10,]
data_filtered <- data_in %>% filter(`Countries and territories`%in%top10$`Countries and territories`)

#calculate date when 5th death was reported
data_filtered <- data_filtered %>% group_by(GeoId) %>% 
  mutate(days_since_5th_death = day_start-day_start[which(abs(day_sum_deaths-5)==min(abs(day_sum_deaths-5)))][1]) %>% 
  ungroup

# plot world data -----------
# Retrievethe map data

data_in <- data_in %>% mutate(countries = str_replace_all(`Countries and territories`,"_"," "))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"Guinea-Bissau","Guinea"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"United Kingdom","UK"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"United States of America","USA"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"CANADA","Canada"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"Antigua and Barbuda","Antigua"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"Brunei Darussalam","Brunei"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"Saint Vincent and the Grenadines","Grenadines"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"United Republic of Tanzania","Tanzania"))
data_in <- data_in %>% mutate(countries = str_replace_all(countries,"Trinidad and Tobago","Trinidad"))




world_map_data<- map_data("world",region = unique(data_in$countries),wrap=c(-180,180))

world_map_data_merged <- left_join(data_in,world_map_data,by=c("countries" = "region"))

today_world_map_data <- world_map_data_merged %>% filter(day_start==max(world_map_data_merged$day_start))


#map plot
world_map_plot <- ggplot(today_world_map_data, aes(x = long, y = lat)) +
  geom_polygon(aes( group = group, fill = day_sum_cases),color="lightgrey",size=0.1)+
  scale_fill_distiller(palette = "Spectral",direction = -1)+
  labs(title = "World",fill = "total cases\nsince 2019-12-31",subtitle = unique(today_world_map_data$DateRep))+
  theme_ipsum_rc(base_size = 18)




#add data to european countries

# Some EU Contries
eu_countries <- c(
  "Portugal", "Spain", "France", "Switzerland", "Germany",
  "Austria", "Belgium", "UK", "Netherlands","Luxembourg",
  "Denmark", "Poland", "Italy", "Greece","Bulgaria",
  "Croatia", "Slovenia", "Hungary", "Slovakia","Romania",
  "Czech republic"
)
# Retrievethe map data
eu_map_data <- map_data("world", region = eu_countries,wrap=c(-180,180))
#unique(eu_map_data$region)
eu_map_data$region[which(eu_map_data$region=="UK")] <- "United_Kingdom"
eu_map_data$region[which(eu_map_data$region=="Czech Republic")] <- "Czech_Republic"
#compute mean for labeling
eu_map_data_label <- eu_map_data %>%
  group_by(region) %>%
  summarise(long = mean(long), lat = mean(lat))
eu_map_data_merged <- left_join(data_in %>% filter(`Countries and territories`%in%unique(eu_map_data$region)),eu_map_data,
                            by=c("Countries and territories" = "region"))

today_eu_data <- eu_map_data_merged %>% filter(day_start==max(eu_map_data_merged$day_start))
#map plot
eu_map_plot <- ggplot(today_eu_data, aes(x = long, y = lat)) +
  geom_polygon(aes( group = group, fill = day_sum_cases))+
  geom_text(aes(label = region), data = eu_map_data_label,  size = 3, hjust = 0.5)+
  scale_fill_distiller(palette = "Spectral",direction = -1)+
  labs(title = "some european countires",fill = "total cases\nsince 2019-12-31",subtitle = unique(today_eu_data$DateRep))+
  theme_ipsum_rc(base_size = 18)


#case plot
cases_plot <- ggplot(data_filtered, aes(day_start, day_sum_cases, color=GeoId)) +
  geom_point(aes(size = day_sum_deaths,))+
  labs(title = "TOP10 cases - countries: cases of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "deaths since\n 2019-12-31",
       x = "days since 2019-12-31",
       y = "cumulated cases")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=`Countries and territories`))+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)

#deaths plot
deaths_plot <- ggplot(data_filtered, aes(day_start, day_sum_deaths, color=GeoId)) +
  geom_point(aes(size = day_sum_cases,))+
  labs(title = "TOP10 cases - countries: deaths of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 2019-12-31",
       y = "cumulated deaths")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=`Countries and territories`))+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)

#deaths plot 5th death reported
deaths_plot_5th_death <- ggplot(data_filtered %>% filter(days_since_5th_death>=0), aes(days_since_5th_death, day_sum_deaths, color=GeoId)) +
  geom_point(aes(size = day_sum_cases,))+
  labs(title = "TOP10 cases - countries: deaths of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 5th death was reported in country",
       y = "cumulated deaths")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=`Countries and territories`))+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)

```






# current status {.tabset .tabset-fade}

The cases reported since 2019-12-31 by country.


## EU map 

```{r}
eu_map_plot
```

## world map

```{r}
world_map_plot
```

# cases and deaths over time {.tabset .tabset-fade}

The cases and deaths over time since 2019-12-31 by country. Top10 countries selected on individual total cases reported.


## reported cases

```{r}
cases_plot
```

## reported deaths

```{r}
deaths_plot
```

## reported deaths aligned

Deaths over time aligned. Day 0 is the day were the 5th death was reported.

```{r}
deaths_plot_5th_death

```



 


