---
title: "COVID19 visualization"
author: "Stephan Michalik"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
mail: "stephan.michalik@uni-greifswald.de"
output: 
  html_document:
    theme: yeti
    highlight: breezedark
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float:
      collapsed: true
      smooth_scroll: true
      number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F,message=F,warning=F,fig.width=10,fig.height=6)
```

COVID 2019 data from European Centre for Disease Prevention and Control 

```{r}
# COVID 2019 data from European Centre for Disease Prevention and Control


#these libraries are necessary

library(readxl)
library(httr)
library(tidyverse)
library(lubridate)
library(ggrepel)
library(plotly)
library(patchwork)
library(hrbrthemes)
library(DT)
library(helfRlein)

#colors setup
my_colors <- c("#5F4690","#1D6996","#38A6A5","#0F8554","#73AF48","#EDAD08","#E17C05","#CC503E","#94346E","#6F4070","#994E95","#666666")

#create the URL where the dataset is stored with automatic updates every day

GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".csv")))
#download the dataset from the website to a local temporary file

#read the Dataset sheet into “R”. The dataset will be called "data".
data_in <- read_csv(tf)

# date format

data_in <- data_in %>% mutate(dateRep = as.Date(dateRep, "%d/%m/%Y"))

#rename contries Territories
data_in <- data_in %>% mutate(countriesAndTerritories= char_replace(countriesAndTerritories))

#write_file
write_delim(x = data_in,path = "COVID_cases_deaths_reported_by_ECDC.tab",delim = "\t",col_names = T)

data_aggregated <- data_in %>% 
  group_by(countriesAndTerritories) %>% 
  summarise(sum_of_cases = sum(cases),sum_of_deaths = sum(deaths)) %>% 
  arrange(desc(sum_of_cases))

#sum up day for day cases and deaths
data_in <- data_in %>%  mutate(day_start = dense_rank(dateRep))

data_in$day_sum_cases <- NA
data_in$day_sum_deaths <- NA

for(i in unique(data_in$geoId)){
  for(k in unique(data_in$day_start)){
    data_in$day_sum_cases[which(data_in$geoId==i & data_in$day_start==k)] <- 
      sum(data_in$cases[which(data_in$geoId==i & data_in$day_start<=k)])
    data_in$day_sum_deaths[which(data_in$geoId==i & data_in$day_start==k)] <- 
      sum(data_in$deaths[which(data_in$geoId==i & data_in$day_start<=k)])
  }
}


#select  Top10 countries
top10<- data_aggregated[1:10,]
data_filtered <- data_in %>% filter(countriesAndTerritories%in%top10$countriesAndTerritories)

#calculate date when 5th death was reported
data_filtered <- data_filtered %>% group_by(geoId) %>% 
  mutate(days_since_5th_death = day_start-day_start[which(abs(day_sum_deaths-5)==min(abs(day_sum_deaths-5)))][1]) %>% 
  ungroup

#calculate date when 1000th case was reported
data_filtered <- data_filtered %>% group_by(geoId) %>% 
  mutate(days_since_1000th_case = day_start-day_start[which(abs(day_sum_cases-1000)==min(abs(day_sum_cases-1000)))][1]) %>% 
  ungroup


#case plot
cases_plot <- ggplot(data_filtered, aes(day_start, day_sum_cases, color=geoId)) +
  geom_point(aes(size = day_sum_deaths,))+
  labs(title = "TOP10 cases - countries: cases of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "deaths since\n 2019-12-31",
       x = "days since 2019-12-31",
       y = "cumulated cases")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=countriesAndTerritories))+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)

#deaths plot
deaths_plot <- ggplot(data_filtered, aes(day_start, day_sum_deaths, color=geoId)) +
  geom_point(aes(size = day_sum_cases,))+
  labs(title = "TOP10 cases - countries: deaths of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 2019-12-31",
       y = "cumulated deaths")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=countriesAndTerritories))+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)

#deaths plot 1000th reported
deaths_plot_1000th_case <- ggplot(data_filtered %>% filter(days_since_1000th_case>=0), aes(days_since_1000th_case, day_sum_deaths, color=geoId)) +
  geom_point(aes(size = day_sum_cases,))+
  labs(title = "TOP10 cases - countries: deaths of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 1000th cases was reported in country",
       y = "cumulated deaths")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=countriesAndTerritories),box.padding = 0.5)+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)


deaths_plot_1000th_case_facet <- ggplot(data_filtered %>% filter(days_since_1000th_case>=0), aes(days_since_1000th_case, day_sum_deaths, color=geoId)) +
  stat_smooth(method = "gam",fullrange = T,formula = y ~ s(x, bs = "cs"))+
  geom_point(aes(size = day_sum_cases,))+
  labs(title = "TOP10 cases - countries: deaths of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 1000th cases was reported in country",
       y = "cumulated deaths", 
       caption ="Generalized additive models with integrated smoothness estimation were added -- y ~ s(x, bs = 'cs')")+
  scale_color_manual(values = my_colors)+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)+
  facet_wrap(~countriesAndTerritories)




#deaths per day aligned

deaths_plot_1000th_case_per_day <- ggplot(data_filtered %>% filter(days_since_1000th_case>=0), aes(days_since_1000th_case, deaths, fill=geoId)) +
  geom_bar(stat="identity")+
  labs(title = "TOP10 cases - countries: deaths of COVID19 per day",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 1000th cases was reported in country",
       y = "deaths per day")+
  scale_fill_manual(values = my_colors)+
  theme_ipsum_rc(base_size = 18)+
  guides(fill=F)+
  facet_wrap(~countriesAndTerritories)



#cases per day aligned
cases_plot_1000th_case_per_day <- ggplot(data_filtered %>% filter(days_since_1000th_case>=0), aes(days_since_1000th_case, cases, fill=geoId)) +
  geom_bar(stat="identity")+
  labs(title = "TOP10 cases - countries: cases of COVID19 per day",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "cases since\n 2019-12-31",
       x = "days since 1000th cases was reported in country",
       y = "cases per day")+
  scale_fill_manual(values = my_colors)+
  theme_ipsum_rc(base_size = 18)+
  guides(fill=F)+
  facet_wrap(~countriesAndTerritories)

# add curves doubling times ----
#add curves
doubling_time <- seq(1,6)
time<- seq(0,60,by = 0.1)
initial_cases <- 1000

estimated_cases_doubling_time <- c()
for(i in 1:length(doubling_time)){
  
  estimated_cases<- initial_cases*exp(1)^(time*(log(2)/doubling_time[i])) 
  estimated_cases_doubling_time <- bind_rows(estimated_cases_doubling_time,
                                             tibble(days = time, 
                                                    cases = estimated_cases,
                                                    doubling_time = doubling_time[i]))
  
}


#plot plot 1000th case reported
case_plot_1000th_case <- ggplot(data_filtered %>% filter(days_since_1000th_case>=0), aes(days_since_1000th_case, day_sum_cases, color=geoId)) +
  geom_line(data = estimated_cases_doubling_time,
            mapping = aes(days,cases,group = doubling_time,linetype=as.factor(doubling_time)),color="grey")+
  ylim(c(1000,120000))+
    geom_label_repel(data= estimated_cases_doubling_time %>% 
                       filter(cases <110000) %>% 
                       group_by(doubling_time) %>% 
                       top_n(n = 1,wt = cases),
                     mapping = aes(x = days,
                                   y = cases,
                                   label=paste("doubling time:\n", doubling_time,"d")),
                     inherit.aes = F,
                     color="grey")+
  geom_point(aes(size = day_sum_deaths))+
  labs(title = "TOP10 cases - countries: cases of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "deaths since\n 2019-12-31",
       x = "days since 1000th case was reported in country",
       y = "cumulated cases")+
  scale_color_manual(values = my_colors)+
  geom_label_repel(data_filtered %>% filter(day_start==max(data_filtered$day_start)),
                   mapping = aes(label=countriesAndTerritories),box.padding = 0.5)+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)+
  guides(linetype=F)


case_plot_1000th_case_facet <- ggplot(data_filtered %>% filter(days_since_1000th_case>=0), aes(days_since_1000th_case, day_sum_cases, color=geoId)) +
  stat_smooth(method = "gam",fullrange = T,formula = y ~ s(x, bs = "cs"))+
  geom_line(data = estimated_cases_doubling_time,
            mapping = aes(days,cases,group = doubling_time,linetype=as.factor(doubling_time)),color="grey")+
  ylim(c(1000,120000))+
    geom_label_repel(data= estimated_cases_doubling_time %>% 
                       filter(cases <110000) %>% 
                       group_by(doubling_time) %>% 
                       top_n(n = 1,wt = cases),
                     mapping = aes(x = days,
                                   y = cases,
                                   label=paste( doubling_time,"d",sep="")),
                     inherit.aes = F,
                     color="grey", size=3)+
  geom_point(aes(size = day_sum_deaths))+
  labs(title = "TOP10 cases - countries: cases of COVID19 ",
       subtitle = "data from European Centre for Disease Prevention and Control",
       size = "deaths since\n 2019-12-31",
       x = "days since 1000th case was reported in country",
       caption = "Generalized additive models with integrated smoothness estimation were added -- y ~ s(x, bs = 'cs')",
       y = "cumulated cases")+
  scale_color_manual(values = my_colors)+
  theme_ipsum_rc(base_size = 18)+
  guides(color=F)+
  guides(linetype=F)+
  facet_wrap(~countriesAndTerritories)

```





# current status 

The cases/deaths reported since 2019-12-31 by country.

```{r}
DT::datatable(data_aggregated, 
          rownames = F,
          filter = 'top', 
          options = list(pageLength = 10, autoWidth = TRUE),
          caption = 'cases/deaths reported since 2019-12-31 by country')%>% formatStyle(columns = c('sum_of_deaths'),
  background = styleColorBar(range(data_aggregated[,-c(1:2)]), '#C62828'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')%>% 
formatStyle(columns = c('sum_of_cases'),
  background = styleColorBar(range(data_aggregated[,-c(1,3)]), '#EF6C00'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')

```

# cases and deaths over time {.tabset .tabset-fade}

The cases and deaths over time since 2019-12-31 by country. Top10 countries selected on individual total cases reported.


## reported cases aligned

cases over time aligned. Day 0 is the day were the 1000th case was reported.

```{r}
case_plot_1000th_case
```

```{r,fig.width=16,fig.height=10}
case_plot_1000th_case_facet
```


```{r,fig.width=12,fig.height=10}
cases_plot_1000th_case_per_day
```

## reported deaths aligned

deaths over time aligned. Day 0 is the day were the 5th death was reported.

```{r}
deaths_plot_1000th_case
```

```{r,fig.width=16,fig.height=10}
deaths_plot_1000th_case_facet
```


```{r,fig.width=12,fig.height=10}
deaths_plot_1000th_case_per_day
```



## reported cases

```{r}
cases_plot
```

## reported deaths

```{r}
deaths_plot
```




